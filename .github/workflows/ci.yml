name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php-version: ['8.4', '8.5']

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: none
          tools: phpize

      - name: Build extension
        run: |
          phpize
          ./configure --enable-tui
          make -j$(nproc)

      - name: Run tests
        run: make test TESTS='-q --show-diff'

  coverage:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: none
          tools: phpize

      - name: Build extension with coverage
        run: |
          phpize
          ./configure --enable-tui --enable-tui-gcov
          make -j$(nproc)

      - name: Run tests
        run: make test TESTS='-q'

      - name: Generate coverage report
        run: |
          mkdir -p coverage
          lcov --capture --directory . --output-file coverage/coverage.info \
            --exclude '/usr/*' \
            --exclude '*/src/yoga/*' \
            --ignore-errors inconsistent,unused
          lcov --list coverage/coverage.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/coverage.info
          fail_ci_if_error: false

  static-analysis:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: none
          tools: phpize

      - name: Configure (for compile_commands.json context)
        run: |
          phpize
          ./configure --enable-tui

      - name: Run clang-tidy
        run: |
          PHP_INCLUDE=$(php-config --include-dir)
          clang-tidy tui.c \
            --quiet \
            -- -I. -I./src -I$PHP_INCLUDE -I$PHP_INCLUDE/main \
            -I$PHP_INCLUDE/TSRM -I$PHP_INCLUDE/Zend -I$PHP_INCLUDE/ext \
            -DHAVE_CONFIG_H 2>/dev/null || true

  valgrind:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind

      - name: Setup PHP with debug
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: none
          tools: phpize
          # Debug build for better valgrind output
          ini-values: memory_limit=512M

      - name: Build extension
        run: |
          phpize
          ./configure --enable-tui
          make -j$(nproc)

      - name: Run valgrind memory leak tests
        run: |
          # Run a subset of tests under valgrind
          USE_ZEND_ALLOC=0 valgrind --leak-check=full --show-reachable=yes \
            --suppressions=/usr/share/php/.supp 2>&1 \
            php -d extension=modules/tui.so -r '
              // Basic smoke test for memory leaks
              $width = tui_string_width("Hello");
              $wrapped = tui_wrap_text("Hello World", 5);
              $truncated = tui_truncate("Hello World", 8);
              echo "Memory test passed\n";
            ' | tee valgrind.log

          # Check for definite leaks (exit non-zero if found)
          if grep -q "definitely lost: [^0]" valgrind.log; then
            echo "Memory leaks detected!"
            exit 1
          fi

  asan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: none
          tools: phpize

      - name: Build extension with AddressSanitizer
        run: |
          phpize
          ./configure --enable-tui
          # Build with ASAN flags
          make CFLAGS="-fsanitize=address -g -O1 -fno-omit-frame-pointer" \
               LDFLAGS="-fsanitize=address" \
               -j$(nproc)

      - name: Run tests with ASAN
        env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=0:log_path=asan.log
        run: |
          make test TESTS='-q' || true
          # Check for ASAN errors
          if ls asan.log.* 1>/dev/null 2>&1; then
            echo "AddressSanitizer errors detected:"
            cat asan.log.*
            exit 1
          fi
          echo "No AddressSanitizer errors found"

  macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: none
          tools: phpize

      - name: Build extension
        run: |
          phpize
          ./configure --enable-tui
          make -j$(sysctl -n hw.ncpu)

      - name: Run tests
        run: make test TESTS='-q --show-diff'
